# 地価データ取得機能ガイド

## 概要

このガイドでは、国土交通省の不動産情報ライブラリAPIを使用した地価データ取得機能の使い方を説明します。

## 機能説明

### 取得されるデータ

物件の住所から以下の情報を自動的に取得します：

1. **地価（万円/m²）**: 該当地域の公示地価（国土交通省の地価公示データ）
2. **地価倍率**: 物件の土地単価を地価で割った倍率（例: 1.23x）

### 地価倍率の意味

地価倍率は、物件の土地単価が公示地価の何倍かを示します：

- **1.0x前後**: 公示地価と同程度の価格
- **1.5x以上**: 公示地価より高い（人気エリア、好立地など）
- **0.5x〜1.0x**: 公示地価より安い（割安物件の可能性）

## セットアップ

### 1. APIキーの取得

1. [不動産情報ライブラリ](https://www.reinfolib.mlit.go.jp/)にアクセス
2. 「API利用申請」ページから申請フォームを記入
   - 氏名
   - メールアドレス
   - 利用目的（例: 不動産データの分析・研究）
3. 申請後、メールでAPIキーが送付されます

### 2. 環境変数の設定

#### ローカル環境

```bash
export REINFOLIB_API_KEY="your_api_key_here"
```

#### GitHub Actions

1. リポジトリの Settings > Secrets and variables > Actions に移動
2. "New repository secret" をクリック
3. 以下を入力：
   - Name: `REINFOLIB_API_KEY`
   - Value: 取得したAPIキー
4. "Add secret" をクリック

### 3. スクレイピング実行

APIキーが設定されていれば、通常通りスクレイピングを実行するだけで自動的に地価データが取得されます：

```bash
python scripts/scrape_sumstock.py https://sumstock.jp/search/02/12/12207
```

## 出力例

### Markdownテーブル

```markdown
| 所在地（町名） | 総額 | 建物価格 | 建物面積 | 建物単価（万円/m²） | 土地価格 | 土地面積 | 土地単価（万円/m²） | 地価（万円/m²） | 地価倍率 | ハウスメーカー |
|----------------|-------|------------|-------------|------------------------|------------|-------------|------------------------|----------------|----------|----------------|
| 松戸市中金杉1丁目 | 3,280万円 | 1,054万円 | 112.85m² | 約9.34万円/m² | 2,226万円 | 151.45m² | 約14.70万円/m² | 約25.50万円/m² | 0.58x | 積水ハウス |
```

### 新しい列の説明

- **地価（万円/m²）**: 国土交通省APIから取得した公示地価
  - 形式: `約XX.XX万円/m²`
  - APIキーがない場合や取得失敗時: `-`
  
- **地価倍率**: 土地単価 ÷ 地価
  - 形式: `X.XXx`（例: `0.58x`、`1.23x`）
  - 計算できない場合: `-`

## 対応地域

現在、以下の地域に対応しています：

### 千葉県
- 千葉市（全区）
- 松戸市、柏市、市川市、船橋市、習志野市など主要都市

### 東京都
- 23区全て
- 八王子市、立川市、町田市など多摩地域の主要都市

### 神奈川県
- 横浜市（全区）
- 川崎市（全区）

### 埼玉県
- さいたま市（全区）

その他の地域を追加する場合は、`scripts/land_price.py` の `city_to_codes` 辞書に追加してください。

## トラブルシューティング

### Q: 地価データが取得されない（常に「-」が表示される）

**A:** 以下を確認してください：
1. APIキーが正しく設定されているか
2. 住所が対応地域に含まれているか
3. ネットワーク接続が正常か

### Q: APIレート制限に引っかかる

**A:** 不動産情報ライブラリAPIにはレート制限があります。以下の対策を検討してください：
- リクエスト間隔を空ける
- キャッシュ機能の実装（将来の機能）
- バッチ処理の分割

### Q: 特定の住所で地価が取得できない

**A:** 以下の理由が考えられます：
1. 該当地域の地価データがAPIに存在しない
2. 住所の解析が失敗している
3. 市区町村コードのマッピングが不足している

解決方法：
- `scripts/land_price.py` の `city_to_codes` に該当市区町村を追加
- 住所フォーマットを確認

## 技術的な詳細

### アーキテクチャ

```
┌─────────────────┐
│  scrape_sumstock│
│       .py       │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  land_price.py  │
├─────────────────┤
│ ・parse_address │
│ ・fetch_land_   │
│   price         │
│ ・calculate_    │
│   ratio         │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  不動産情報     │
│  ライブラリAPI  │
└─────────────────┘
```

### モジュール構成

#### `land_price.py`

主要な関数：

1. **`parse_address(address: str) -> Tuple[Optional[str], Optional[str]]`**
   - 住所文字列から都道府県コードと市区町村コードを抽出
   - 返り値: `(pref_code, city_code)`

2. **`fetch_land_price(pref_code: str, city_code: str, year: str) -> Optional[float]`**
   - APIから地価データを取得
   - 返り値: 万円/m²単位の地価（平均値）

3. **`calculate_ratio(unit_price: float, land_price: float) -> Optional[str]`**
   - 地価倍率を計算
   - 返り値: フォーマットされた文字列（例: "1.23x"）

4. **`get_land_price_info(address: str) -> Tuple[Optional[float], Optional[str]]`**
   - 住所から地価情報を取得（上記関数を統合）
   - 返り値: `(地価の数値, 表示用文字列)`

## API利用規約

不動産情報ライブラリAPIを使用する際は、以下の点に注意してください：

- APIキーを他人と共有しない
- レート制限を守る
- 商用利用の場合は利用規約を確認
- データの出典を明記する

詳細は[不動産情報ライブラリの利用規約](https://www.reinfolib.mlit.go.jp/)を参照してください。

## テスト

### ユニットテスト

```bash
# 地価モジュールのテスト
python tests/test_land_price.py

# 統合テスト
python tests/test_land_price_integration.py
```

### テストケース

1. **住所解析テスト**: 様々な住所形式の解析
2. **地価倍率計算テスト**: 異なる値での倍率計算
3. **APIフォールバックテスト**: APIキーがない場合の動作
4. **統合テスト**: スクレイパーとの統合動作

## 今後の拡張予定

- [ ] より多くの地域への対応
- [ ] キャッシュ機能の実装
- [ ] 複数年の地価データ比較
- [ ] 地価の推移グラフ表示
- [ ] 不動産取引価格（成約価格）の取得
